@using Microsoft.AspNetCore.Html;
@using Console.ViewModels;

@{
    ViewData["Title"] = "Visualizer";
    Layout = "_Layout";
}

@functions {
    string CreateViewControl(string spanid, string iconid, string faclass, string tooltip)
    {
        var element = "<span id=\"" + spanid + "\" class=\"viewcontrol\" data-tooltip data-position=\"right\" data-alignment=\"center\" data-click-open=\"false\" data-hover-delay=\"1000\" title=\""+ tooltip + "\">" +
            "< i id = \""+ iconid + "\" class=\"fas "+ faclass + "\"></i>"+
            "</span>";
        return element;
    }
}

@section Styles
{
    <link rel="stylesheet" type="text/css" href="~/visualizer/css/main.css">
    <link rel="stylesheet" type="text/css" href="~/visualizer/css/visualization.css">
    <link rel="stylesheet" type="text/css" href="~/css/jquery-ui.css">
}

<div id="pagewrapper">
    <div id="main">
        <div id="querybar" class="grid-x grid-padding-x">
            <form id="sourceForm" class="small-12 medium-12 cell" type="POST" action="javascript:search()">
                <div class="grid-x grid-margin-x">
                    <fieldset class="fieldset small-4 cell">
                        <legend>Source</legend>

                        <div class="input-group">
                            <span class="input-group-label small-4">Type</span>
                            <select id="sourceType" class="small-8 input-group-field" autofocus onchange="updateProps('source')">
                                <option value="" disabled selected hidden></option>
                                <option value="">*</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <span class="input-group-label small-4">Where</span>
                            <select id="sourceProp" class="small-8 input-group-field"></select>
                        </div>
                        <div class="input-group">
                            <span class="input-group-label small-4">Equals</span>
                            <input type="text" id="sourceVal" placeholder="Value" class="small-8 input-group-field">
                        </div>
                    </fieldset>

                    <fieldset class="fieldset small-4 cell">
                        <legend>Relationship</legend>

                        <div class="input-group">
                            <span class="input-group-label small-3">Type</span>
                            <select id="edgeType" class="small-9 input-group-field">
                                <option value="" disabled selected hidden></option>
                                <option value="">*</option>
                            </select>
                        </div>

                        <span class="">Path Length</span>
                        <div class="input-group">
                            <div class="grid-x input-group-field">
                                <div class="cell small-2">
                                    <input type="number" id="sliderMin">
                                </div>
                                <div class="cell small-8">
                                    <div class="slider" data-slider data-initial-start="0" data-initial-end="5" data-start="0" data-end="20">
                                        <span class="slider-handle" data-slider-handle role="slider" aria-controls="sliderMin"></span>
                                        <span class="slider-fill" data-slider-fill></span>
                                        <span class="slider-handle" data-slider-handle role="slider" aria-controls="sliderMax"></span>
                                    </div>
                                </div>
                                <div class="cell small-2">
                                    <input type="number" id="sliderMax">
                                </div>
                            </div>
                        </div>

                        <div class="grid-x cell align-top">
                            <span class="cell small-3 align-middle">Direction</span>
                            <a class="cell small-1 text-left" href='javascript:toggleDir()'>
                                <i id='dirIcon' class="fas fa-arrow-right" data-dir="R"></i>
                            </a>
                        </div>
                    </fieldset>

                    <fieldset class="fieldset small-4 cell">
                        <legend>Target</legend>

                        <div class="input-group">
                            <span class="input-group-label small-3">Type</span>
                            <select id="targetType" class="small-9 input-group-field" onchange="updateProps('target')">
                                <option value="" disabled selected hidden></option>
                                <option value="">*</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <span class="input-group-label small-3">Where</span>
                            <select id="targetProp" class="small-9 input-group-field"></select>
                        </div>
                        <div class="input-group">
                            <span class="input-group-label small-3">Equals</span>
                            <input type="text" id="targetVal" placeholder="Value" class="small-9 input-group-field">
                        </div>
                    </fieldset>
                </div>
                <div class="grid-x cell align-middle">
                    <div class="cell small-3 medium-1">
                        <input type="submit" class="button" value="Search">
                    </div>
                    <div class="cell small-7 medium-auto">
                        <p id="searchNotification"></p>
                    </div>
                    <div class="cell small-2 text-right">
                        <p><a href='javascript:resetView()'>Clear view</a></p>
                    </div>
                </div>
            </form>

        </div>

        <div id="drawingpane">
            <div id="viewcontrols">
                @{
                    var controls = new List<ViewControlViewModel>();
                    controls.Add(new ViewControlViewModel
                    {
                        SpanID = "restartLayoutBtn",
                        IconID = "restartIcon",
                        FaIcon = "fa-sync-alt",
                        ToolTipText = "Refresh layout"
                    });
                    controls.Add(new ViewControlViewModel
                    {
                        SpanID = "pausePlayBtn",
                        IconID = "pausePlayIcon",
                        FaIcon = "fa-play",
                        ToolTipText = "Play/pause layout"
                    });
                    controls.Add(new ViewControlViewModel
                    {
                        SpanID = "removeBtn",
                        IconID = "removeIcon",
                        FaIcon = "fa-trash-alt",
                        ToolTipText = "Remove node from layout"
                    });
                    controls.Add(new ViewControlViewModel
                    {
                        SpanID = "menuShowHideButton",
                        IconID = "menuIcon",
                        FaIcon = "fa-angle-up",
                        ToolTipText = "Hide the search bar",
                        Class = "viewcontrol-right"
                    });
                    foreach (var control in controls)
                    {
                        <partial name="ViewControlPartial" model="control" />
                    }
                }
            </div>


        </div>

        <div id="graphstatus" class="grid-x">
            <span id="statusIcon" class="cell small-2"></span>
            <span id="statusMessage" class="cell small-10"></span>
        </div>

        <div id="detailcardwrapper"></div>
    </div>
</div>

@section Scripts
    {
    <script defer src="~/js/fontawesome/all.js" type="text/javascript"></script>
    <script src="~/js/jquery-ui/jquery-ui.js"></script>
    <script src="~/visualizer/js/d3.min.js"></script>
    <script src="~/visualizer/js/visualizer.js" type="text/javascript"></script>
    <script>
        var iconmappings;
        $.getJSON("json/labelicons.json", function (data) {
            iconmappings = new IconMappings(data);
        });
        $.getJSON("/api/nodes/labels", function (data) {
            for (var i = 0; i < data.length; ++i) {
                addOption(document.getElementById("sourceType"), data[i], data[i])
            }
            for (var i = 0; i < data.length; ++i) {
                addOption(document.getElementById("targetType"), data[i], data[i])
            }
        });
        $.getJSON("/api/edges/labels", function (data) {
            for (var i = 0; i < data.length; ++i) {
                addOption(document.getElementById("edgeType"), data[i], data[i])
            }
        });

        $("#menuShowHideButton").click(function () {
            var icon = $("#menuIcon");
            if (icon.hasClass("fa-angle-up")) {
                icon.removeClass("fa-angle-up");
                icon.addClass("fa-angle-down");
            }
            else {
                icon.removeClass("fa-angle-down");
                icon.addClass("fa-angle-up");
            }
            $("#querybar").slideToggle();
        });

        drawGraph('drawingpane');
    </script>
}